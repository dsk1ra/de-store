<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DE-Store API Testing</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, sans-serif;
            background: #f5f5f5;
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border: 1px solid #ddd;
        }

        .header {
            background: #2c3e50;
            color: white;
            padding: 20px 30px;
            border-bottom: 1px solid #34495e;
        }

        .header h1 {
            font-size: 1.5em;
            font-weight: 600;
        }

        .content {
            padding: 30px;
        }

        .auth-section {
            background: #fafafa;
            padding: 20px;
            border: 1px solid #ddd;
            margin-bottom: 30px;
        }

        .auth-section h2 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.2em;
            font-weight: 600;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            font-weight: 500;
            margin-bottom: 5px;
            color: #333;
            font-size: 0.9em;
        }

        input,
        select,
        textarea {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid #ccc;
            font-size: 14px;
            font-family: inherit;
        }

        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: #2c3e50;
        }

        textarea {
            min-height: 100px;
            font-family: 'Courier New', monospace;
        }

        .btn {
            padding: 8px 16px;
            border: 1px solid #ccc;
            background: white;
            font-size: 14px;
            cursor: pointer;
            margin-right: 10px;
            margin-top: 10px;
        }

        .btn:hover {
            background: #f5f5f5;
        }

        .btn-primary {
            background: #2c3e50;
            color: white;
            border-color: #2c3e50;
        }

        .btn-primary:hover {
            background: #34495e;
            border-color: #34495e;
        }

        .btn-success {
            background: #27ae60;
            color: white;
            border-color: #27ae60;
        }

        .btn-success:hover {
            background: #229954;
            border-color: #229954;
        }

        .btn-danger {
            background: #c0392b;
            color: white;
            border-color: #c0392b;
        }

        .btn-danger:hover {
            background: #a93226;
            border-color: #a93226;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .token-display {
            background: #f9f9f9;
            padding: 12px;
            margin-top: 15px;
            word-break: break-all;
            font-family: 'Courier New', monospace;
            font-size: 11px;
            border: 1px solid #ddd;
        }

        .api-section {
            margin-bottom: 30px;
            padding: 20px;
            background: #fafafa;
            border: 1px solid #ddd;
        }

        .api-section h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.1em;
            font-weight: 600;
        }

        .response-area {
            background: #f9f9f9;
            color: #333;
            padding: 12px;
            margin-top: 15px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            border: 1px solid #ddd;
        }

        .response-area.success {
            border-left: 3px solid #27ae60;
        }

        .response-area.error {
            border-left: 3px solid #c0392b;
        }

        .response-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .view-toggle {
            display: inline-flex;
            background: #f0f0f0;
            border: 1px solid #ccc;
            border-radius: 3px;
            overflow: hidden;
        }

        .view-toggle button {
            padding: 5px 12px;
            border: none;
            background: transparent;
            cursor: pointer;
            font-size: 12px;
            margin: 0;
        }

        .view-toggle button.active {
            background: #2c3e50;
            color: white;
        }

        .view-toggle button:hover:not(.active) {
            background: #e0e0e0;
        }

        .table-view {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }

        .table-view th {
            background: #34495e;
            color: white;
            padding: 8px;
            text-align: left;
            font-weight: 600;
            border: 1px solid #2c3e50;
        }

        .table-view td {
            padding: 8px;
            border: 1px solid #ddd;
            word-break: break-word;
        }

        .table-view tr:nth-child(even) {
            background: #f9f9f9;
        }

        .table-view tr:hover {
            background: #f0f0f0;
        }

        .collapsible {
            cursor: pointer;
            user-select: none;
            color: #2c3e50;
            font-weight: 600;
        }

        .collapsible:hover {
            text-decoration: underline;
        }

        .collapsible::before {
            content: '▼ ';
            display: inline-block;
            transition: transform 0.2s;
        }

        .collapsible.collapsed::before {
            transform: rotate(-90deg);
        }

        .nested-content {
            margin-left: 20px;
            margin-top: 5px;
            padding-left: 10px;
            border-left: 2px solid #ddd;
        }

        .nested-content.collapsed {
            display: none;
        }

        .key-label {
            color: #8e44ad;
            font-weight: 600;
        }

        .value-string {
            color: #27ae60;
        }

        .value-number {
            color: #2980b9;
        }

        .value-boolean {
            color: #e67e22;
        }

        .value-null {
            color: #95a5a6;
            font-style: italic;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        @media (max-width: 768px) {
            .grid-2 {
                grid-template-columns: 1fr;
            }
        }

        .loading {
            display: inline-block;
            width: 14px;
            height: 14px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #2c3e50;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 8px;
            vertical-align: middle;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .test-all-btn {
            width: 100%;
            padding: 12px;
            font-size: 14px;
            margin-top: 20px;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>DE-Store API Testing</h1>
        </div>

        <div class="content">
            <!-- Authentication Section -->
            <div class="auth-section">
                <h2>Authentication</h2>
                <div class="grid-2">
                    <div class="form-group">
                        <label for="username">Username</label>
                        <input type="text" id="username" value="admin" placeholder="Enter username">
                    </div>
                    <div class="form-group">
                        <label for="password">Password</label>
                        <input type="password" id="password" value="Admin123!" placeholder="Enter password">
                    </div>
                </div>
                <button class="btn btn-primary" onclick="login(event)">Login</button>
                <button class="btn btn-secondary" onclick="clearToken()">Clear Token</button>
                <div id="tokenDisplay" class="token-display" style="display:none;">
                    <strong>Access Token:</strong><br>
                    <span id="tokenValue"></span>
                </div>
            </div>

            <div id="secured-content" style="display:none;">
                <!-- Pricing Service -->
                <div class="api-section">
                    <h3>Pricing Service</h3>

                    <div class="form-group">
                        <label>Create Product</label>
                        <div class="grid-2">
                            <input type="text" id="productCode" placeholder="Product Code" value="">
                            <input type="text" id="productName" placeholder="Product Name" value="">
                        </div>
                        <input type="number" id="basePrice" placeholder="Base Price" value="" style="margin-top:10px">
                        <button class="btn btn-success" onclick="createProduct(event)">Create Product</button>
                        <button class="btn btn-secondary" onclick="getProduct(event)">Get Product</button>
                        <button class="btn btn-secondary" onclick="updateProduct(event)">Update Product</button>
                        <button class="btn btn-danger" onclick="deleteProduct(event)">Delete Product</button>
                    </div>

                    <div class="form-group">
                        <label>Search Products</label>
                        <input type="text" id="productSearch" placeholder="Search by name or code" value="">
                        <button class="btn btn-primary" onclick="searchProducts(event)">Search</button>
                    </div>

                    <div class="form-group">
                        <label>Create Promotion</label>
                        <input type="text" id="promoCode" placeholder="Promotion Code" value="">
                        <input type="text" id="promoName" placeholder="Promotion Name" value="" style="margin-top:10px">
                        <input type="text" id="promoApplicableProducts"
                            placeholder="Applicable Product Codes (comma-separated)" value="" style="margin-top:10px">
                        <select id="promoType" style="margin-top:10px" onchange="toggleDiscountValue()">
                            <option value="BOGO">Buy One Get One (BOGO)</option>
                            <option value="THREE_FOR_TWO">Three for Two</option>
                            <option value="PERCENTAGE_DISCOUNT">Percentage Discount</option>
                            <option value="FIXED_AMOUNT">Fixed Amount</option>
                        </select>
                        <div id="discountValueContainer" style="margin-top:10px; display:none;">
                            <input type="number" id="discountValue"
                                placeholder="Discount Value (e.g. 10 for 10% or 5.00)" value="" step="0.01" min="0">
                            <small id="discountHint" style="display:block; color:#666; margin-top:5px;"></small>
                        </div>
                        <button class="btn btn-success" onclick="createPromotion(event)">Create Promotion</button>
                    </div>

                    <div class="form-group">
                        <label>Calculate Price</label>
                        <div class="grid-2">
                            <input type="text" id="calcProductCode" placeholder="Product Code" value="">
                            <input type="number" id="calcQuantity" placeholder="Quantity" value="">
                        </div>
                        <button class="btn btn-primary" onclick="calculatePrice(event)">Calculate Price</button>
                    </div>

                    <div class="response-header" id="pricingResponseHeader" style="display:none;">
                        <strong>Response:</strong>
                        <div class="view-toggle">
                            <button onclick="toggleView('pricingResponse', 'json')" class="active"
                                id="pricingResponse-json-btn">JSON</button>
                            <button onclick="toggleView('pricingResponse', 'table')"
                                id="pricingResponse-table-btn">Table</button>
                        </div>
                    </div>
                    <div id="pricingResponse" class="response-area" style="display:none;"></div>
                </div>

                <!-- Inventory Service -->
                <div class="api-section">
                    <h3>Inventory Service</h3>

                    <div class="form-group">
                        <label>Create Inventory</label>
                        <div class="grid-2">
                            <input type="text" id="invProductCode" placeholder="Product Code" value="">
                            <input type="number" id="invQuantity" placeholder="Quantity" value="">
                        </div>
                        <div class="grid-2" style="margin-top:10px">
                            <input type="number" id="invThreshold" placeholder="Low Stock Threshold" value="">
                            <input type="text" id="invStoreId" placeholder="Store ID" value="">
                        </div>
                        <button class="btn btn-success" onclick="createInventory(event)">Create Inventory</button>
                        <button class="btn btn-secondary" onclick="getInventory(event)">Get Inventory</button>
                        <button class="btn btn-secondary" onclick="updateInventory(event)">Update Quantity</button>
                    </div>

                    <div class="form-group">
                        <label>Check Low Stock Items</label>
                        <input type="text" id="lowStockStoreId" placeholder="Store ID (optional)" value="">
                        <button class="btn btn-primary" onclick="checkLowStock(event)">Check Low Stock</button>
                    </div>

                    <div class="form-group">
                        <label>Reserve Items</label>
                        <div class="grid-2">
                            <input type="text" id="reserveProductCode" placeholder="Product Code" value="">
                            <input type="number" id="reserveQuantity" placeholder="Quantity" value="">
                        </div>
                        <input type="text" id="referenceId" placeholder="Reference/Order ID" value=""
                            style="margin-top:10px">
                        <button class="btn btn-primary" onclick="reserveItems(event)">Reserve Items</button>
                    </div>

                    <div class="response-header" id="inventoryResponseHeader" style="display:none;">
                        <strong>Response:</strong>
                        <div class="view-toggle">
                            <button onclick="toggleView('inventoryResponse', 'json')" class="active"
                                id="inventoryResponse-json-btn">JSON</button>
                            <button onclick="toggleView('inventoryResponse', 'table')"
                                id="inventoryResponse-table-btn">Table</button>
                        </div>
                    </div>
                    <div id="inventoryResponse" class="response-area" style="display:none;"></div>
                </div>

                <!-- Finance Service -->
                <div class="api-section">
                    <h3>Finance Service (Queue-Based Approval)</h3>

                    <div class="form-group">
                        <label>Request Finance Approval (Sends to Queue)</label>
                        <input type="text" id="customerId" placeholder="Customer ID" value="">
                        <input type="number" id="amount" placeholder="Amount" value="" style="margin-top:10px">
                        <input type="text" id="purpose" placeholder="Purpose" value="" style="margin-top:10px">
                        <button class="btn btn-primary" onclick="requestFinanceApproval(event)">Submit to Queue</button>
                    </div>

                    <div class="form-group">
                        <label>Queue Monitoring</label>
                        <button class="btn btn-secondary" onclick="viewPendingQueue(event)">View Pending Queue</button>
                        <button class="btn btn-secondary" onclick="viewQueueStats(event)">View Queue Statistics</button>
                    </div>

                    <div class="form-group">
                        <label>Process Request from Queue (Manual Approval/Decline)</label>
                        <input type="text" id="approvalRequestId" placeholder="Request ID (from queue)" value="">
                        <div style="margin-top:10px">
                            <button class="btn btn-success" onclick="approveFinance(event)">Approve & Process</button>
                            <button class="btn btn-danger" onclick="declineFinance(event)">Decline & Process</button>
                        </div>
                        <small style="color:#666;display:block;margin-top:5px;">Note: Approval/Decline decisions are
                            queued and processed asynchronously</small>
                    </div>

                    <div class="form-group">
                        <label>Check Request Status</label>
                        <input type="text" id="checkRequestId" placeholder="Request ID" value="">
                        <button class="btn btn-secondary" onclick="checkFinanceStatus(event)">Check Status</button>
                    </div>

                    <div class="response-header" id="financeResponseHeader" style="display:none;">
                        <strong>Response:</strong>
                        <div class="view-toggle">
                            <button onclick="toggleView('financeResponse', 'json')" class="active"
                                id="financeResponse-json-btn">JSON</button>
                            <button onclick="toggleView('financeResponse', 'table')"
                                id="financeResponse-table-btn">Table</button>
                        </div>
                    </div>
                    <div id="financeResponse" class="response-area" style="display:none;"></div>
                </div>

                <!-- View All Section -->
                <div class="api-section">
                    <h3>View All Data</h3>

                    <div class="form-group">
                        <label>View All Products</label>
                        <div class="grid-2">
                            <select id="productLimit">
                                <option value="10">Limit: 10</option>
                                <option value="50">Limit: 50</option>
                                <option value="100">Limit: 100</option>
                                <option value="500">Limit: 500</option>
                            </select>
                            <input type="number" id="productPage" placeholder="Page (optional)" value="">
                        </div>
                        <button class="btn btn-primary" onclick="viewAllProducts(event)">View All Products</button>
                    </div>

                    <div class="form-group">
                        <label>View All Inventory Items</label>
                        <div class="grid-2">
                            <select id="inventoryLimit">
                                <option value="10">Limit: 10</option>
                                <option value="50">Limit: 50</option>
                                <option value="100">Limit: 100</option>
                                <option value="500">Limit: 500</option>
                            </select>
                            <input type="text" id="storeIdFilter" placeholder="Store ID (optional)" value="">
                        </div>
                        <button class="btn btn-primary" onclick="viewAllInventory(event)">View All Inventory</button>
                    </div>

                    <div class="form-group">
                        <label>View All Promotions</label>
                        <select id="promotionLimit">
                            <option value="10">Limit: 10</option>
                            <option value="50">Limit: 50</option>
                            <option value="100">Limit: 100</option>
                        </select>
                        <button class="btn btn-primary" onclick="viewAllPromotions(event)">View All Promotions</button>
                    </div>

                    <div class="form-group">
                        <label>View All Finance Requests</label>
                        <select id="financeLimit">
                            <option value="10">Limit: 10</option>
                            <option value="50">Limit: 50</option>
                            <option value="100">Limit: 100</option>
                        </select>
                        <select id="financeStatus" style="margin-top:10px">
                            <option value="">All Statuses</option>
                            <option value="PENDING">Pending</option>
                            <option value="APPROVED">Approved</option>
                            <option value="DECLINED">Declined</option>
                        </select>
                        <button class="btn btn-primary" onclick="viewAllFinanceRequests(event)">View All
                            Requests</button>
                    </div>

                    <div class="response-header" id="viewAllResponseHeader" style="display:none;">
                        <strong>Response:</strong>
                        <div class="view-toggle">
                            <button onclick="toggleView('viewAllResponse', 'json')" class="active"
                                id="viewAllResponse-json-btn">JSON</button>
                            <button onclick="toggleView('viewAllResponse', 'table')"
                                id="viewAllResponse-table-btn">Table</button>
                        </div>
                    </div>
                    <div id="viewAllResponse" class="response-area" style="display:none;"></div>
                </div>

                <!-- Utilities Section -->
                <div class="api-section">
                    <h3>Utilities</h3>
                    <button class="btn btn-primary" onclick="testAllAPIs(event)">Test All APIs</button>
                    <button class="btn btn-secondary" onclick="clearAllResponses()">Clear All Responses</button>
                    <button class="btn btn-secondary" onclick="exportResponses()">Export Responses</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const BASE_URL = 'http://localhost:8080';
        let accessToken = null;
        const responseData = {};

        function showResponse(elementId, data, isError = false) {
            const element = document.getElementById(elementId);
            const header = document.getElementById(elementId + 'Header');

            // Store the data
            responseData[elementId] = data;

            // Show header and response area
            if (header) header.style.display = 'flex';
            element.style.display = 'block';
            element.className = 'response-area ' + (isError ? 'error' : 'success');

            // Default to JSON view
            element.innerHTML = '';
            element.textContent = JSON.stringify(data, null, 2);

            // Reset toggle buttons
            const jsonBtn = document.getElementById(elementId + '-json-btn');
            const tableBtn = document.getElementById(elementId + '-table-btn');
            if (jsonBtn) jsonBtn.className = 'active';
            if (tableBtn) tableBtn.className = '';
        }

        function showLoading(button) {
            button.disabled = true;
            button.innerHTML += ' <span class="loading"></span>';
        }

        function hideLoading(button, originalText) {
            button.disabled = false;
            button.innerHTML = originalText;
        }

        async function login(event) {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const btn = event.target;
            const originalText = btn.innerHTML;

            try {
                showLoading(btn);
                const response = await fetch(`${BASE_URL}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });

                const data = await response.json();

                if (data.success) {
                    accessToken = data.data.accessToken;
                    document.getElementById('tokenDisplay').style.display = 'block';
                    document.getElementById('tokenValue').textContent = accessToken;
                    document.getElementById('secured-content').style.display = 'block';
                    alert('Login successful');
                } else {
                    alert('Login failed: ' + data.message);
                }
            } catch (error) {
                alert('Error: ' + error.message);
            } finally {
                hideLoading(btn, originalText);
            }
        }

        function clearToken() {
            accessToken = null;
            document.getElementById('tokenDisplay').style.display = 'none';
            document.getElementById('tokenValue').textContent = '';
            document.getElementById('secured-content').style.display = 'none';
            alert('Token cleared');
        }

        function checkAuth() {
            if (!accessToken) {
                alert('Please login first');
                return false;
            }
            return true;
        }

        function getHeaders() {
            return {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${accessToken}`
            };
        }

        async function createProduct(event) {
            if (!checkAuth()) return;
            const btn = event.target;
            const originalText = btn.innerHTML;

            try {
                showLoading(btn);
                const response = await fetch(`${BASE_URL}/api/pricing/products`, {
                    method: 'POST',
                    headers: getHeaders(),
                    body: JSON.stringify({
                        productCode: document.getElementById('productCode').value,
                        productName: document.getElementById('productName').value,
                        basePrice: parseFloat(document.getElementById('basePrice').value)
                    })
                });

                const data = await response.json();
                showResponse('pricingResponse', data, !response.ok);
            } catch (error) {
                showResponse('pricingResponse', { error: error.message }, true);
            } finally {
                hideLoading(btn, originalText);
            }
        }

        async function getProduct(event) {
            if (!checkAuth()) return;
            const btn = event.target;
            const originalText = btn.innerHTML;

            try {
                showLoading(btn);
                const productCode = document.getElementById('productCode').value;
                const response = await fetch(`${BASE_URL}/api/pricing/products/${productCode}`, {
                    method: 'GET',
                    headers: getHeaders()
                });

                const data = await response.json();
                showResponse('pricingResponse', data, !response.ok);
            } catch (error) {
                showResponse('pricingResponse', { error: error.message }, true);
            } finally {
                hideLoading(btn, originalText);
            }
        }

        async function updateProduct(event) {
            if (!checkAuth()) return;
            const btn = event.target;
            const originalText = btn.innerHTML;

            try {
                showLoading(btn);
                const productCode = document.getElementById('productCode').value;
                const response = await fetch(`${BASE_URL}/api/pricing/products/${productCode}`, {
                    method: 'PUT',
                    headers: getHeaders(),
                    body: JSON.stringify({
                        productName: document.getElementById('productName').value,
                        basePrice: parseFloat(document.getElementById('basePrice').value)
                    })
                });

                const data = await response.json();
                showResponse('pricingResponse', data, !response.ok);
            } catch (error) {
                showResponse('pricingResponse', { error: error.message }, true);
            } finally {
                hideLoading(btn, originalText);
            }
        }

        async function deleteProduct(event) {
            if (!checkAuth()) return;
            const productCode = document.getElementById('productCode').value;
            if (!confirm(`Are you sure you want to delete product ${productCode}?`)) return;

            const btn = event.target;
            const originalText = btn.innerHTML;

            try {
                showLoading(btn);
                const response = await fetch(`${BASE_URL}/api/pricing/products/${productCode}`, {
                    method: 'DELETE',
                    headers: getHeaders()
                });

                const data = await response.json();
                showResponse('pricingResponse', data, !response.ok);
            } catch (error) {
                showResponse('pricingResponse', { error: error.message }, true);
            } finally {
                hideLoading(btn, originalText);
            }
        }

        async function searchProducts(event) {
            if (!checkAuth()) return;
            const btn = event.target;
            const originalText = btn.innerHTML;

            try {
                showLoading(btn);
                const searchTerm = document.getElementById('productSearch').value;
                const response = await fetch(`${BASE_URL}/api/pricing/products/search?q=${encodeURIComponent(searchTerm)}`, {
                    method: 'GET',
                    headers: getHeaders()
                });

                const data = await response.json();
                showResponse('pricingResponse', data, !response.ok);
            } catch (error) {
                showResponse('pricingResponse', { error: error.message }, true);
            } finally {
                hideLoading(btn, originalText);
            }
        }

        function toggleDiscountValue() {
            const promoType = document.getElementById('promoType').value;
            const container = document.getElementById('discountValueContainer');
            const discountValue = document.getElementById('discountValue');
            const hint = document.getElementById('discountHint');

            if (promoType === 'BOGO' || promoType === 'THREE_FOR_TWO') {
                container.style.display = 'none';
                discountValue.value = '';
                discountValue.removeAttribute('required');
            } else {
                container.style.display = 'block';
                discountValue.setAttribute('required', 'required');

                if (promoType === 'PERCENTAGE_DISCOUNT') {
                    hint.textContent = 'Enter percentage value (0-100). Example: 25 for 25% off';
                    discountValue.placeholder = 'Enter percentage (0-100)';
                    discountValue.max = '100';
                } else if (promoType === 'FIXED_AMOUNT') {
                    hint.textContent = 'Enter fixed amount to discount per item. Example: 10.00 for £10 off';
                    discountValue.placeholder = 'Enter fixed amount';
                    discountValue.removeAttribute('max');
                }
            }
        }

        async function createPromotion(event) {
            if (!checkAuth()) return;
            const btn = event.target;
            const originalText = btn.innerHTML;

            try {
                showLoading(btn);

                const promoCode = document.getElementById('promoCode').value.trim();
                const promoName = document.getElementById('promoName').value.trim();
                const promoType = document.getElementById('promoType').value;
                const discountValueInput = document.getElementById('discountValue').value;
                const applicableProductsInput = document.getElementById('promoApplicableProducts').value.trim();

                // Frontend validation
                if (!promoCode) {
                    throw new Error('Promotion code is required');
                }
                if (!promoName) {
                    throw new Error('Promotion name is required');
                }
                if (!applicableProductsInput) {
                    throw new Error('At least one product code is required for applicable products');
                }

                // Parse product codes (comma-separated)
                const productCodes = applicableProductsInput.split(',').map(p => p.trim()).filter(p => p.length > 0);
                if (productCodes.length === 0) {
                    throw new Error('At least one valid product code is required');
                }

                // Validate discount value based on promotion type
                let discountValue = null;
                if (promoType === 'PERCENTAGE_DISCOUNT' || promoType === 'FIXED_AMOUNT') {
                    if (!discountValueInput || discountValueInput.trim() === '') {
                        throw new Error(`Discount value is required for ${promoType === 'PERCENTAGE_DISCOUNT' ? 'percentage discount' : 'fixed amount'} promotions`);
                    }

                    discountValue = parseFloat(discountValueInput);

                    if (isNaN(discountValue) || discountValue <= 0) {
                        throw new Error('Discount value must be a positive number');
                    }

                    if (promoType === 'PERCENTAGE_DISCOUNT' && discountValue > 100) {
                        throw new Error('Percentage discount cannot exceed 100%');
                    }
                } else if (promoType === 'BOGO' || promoType === 'THREE_FOR_TWO') {
                    // Explicitly set to null for BOGO and THREE_FOR_TWO
                    discountValue = null;
                }

                const requestBody = {
                    promotionCode: promoCode,
                    promotionName: promoName,
                    promotionType: promoType,
                    applicableProducts: productCodes,
                    startDate: '2025-11-20',
                    endDate: '2025-12-31'
                };

                // Only include discountValue if it's not null
                if (discountValue !== null) {
                    requestBody.discountValue = discountValue;
                }

                const response = await fetch(`${BASE_URL}/api/pricing/promotions`, {
                    method: 'POST',
                    headers: getHeaders(),
                    body: JSON.stringify(requestBody)
                });

                const data = await response.json();

                // Enhanced error message display
                if (!response.ok) {
                    if (data.message) {
                        showResponse('pricingResponse', {
                            error: data.message,
                            details: data,
                            tip: getPromotionTip(promoType)
                        }, true);
                    } else {
                        showResponse('pricingResponse', data, true);
                    }
                } else {
                    showResponse('pricingResponse', data, false);
                }
            } catch (error) {
                showResponse('pricingResponse', {
                    error: error.message,
                    tip: 'Please check your inputs and try again'
                }, true);
            } finally {
                hideLoading(btn, originalText);
            }
        }

        function getPromotionTip(promoType) {
            switch (promoType) {
                case 'BOGO':
                case 'THREE_FOR_TWO':
                    return 'BOGO and THREE_FOR_TWO promotions do not require a discount value';
                case 'PERCENTAGE_DISCOUNT':
                    return 'Percentage discounts require a discount value between 0 and 100';
                case 'FIXED_AMOUNT':
                    return 'Fixed amount promotions require a positive discount value';
                default:
                    return '';
            }
        }

        async function calculatePrice(event) {
            if (!checkAuth()) return;
            const btn = event.target;
            const originalText = btn.innerHTML;

            try {
                showLoading(btn);
                const response = await fetch(`${BASE_URL}/api/pricing/calculate`, {
                    method: 'POST',
                    headers: getHeaders(),
                    body: JSON.stringify({
                        items: [{
                            productCode: document.getElementById('calcProductCode').value,
                            quantity: parseInt(document.getElementById('calcQuantity').value)
                        }]
                    })
                });

                const data = await response.json();
                showResponse('pricingResponse', data, !response.ok);
            } catch (error) {
                showResponse('pricingResponse', { error: error.message }, true);
            } finally {
                hideLoading(btn, originalText);
            }
        }

        async function createInventory(event) {
            if (!checkAuth()) return;
            const btn = event.target;
            const originalText = btn.innerHTML;

            try {
                showLoading(btn);
                const response = await fetch(`${BASE_URL}/api/inventory`, {
                    method: 'POST',
                    headers: getHeaders(),
                    body: JSON.stringify({
                        productCode: document.getElementById('invProductCode').value,
                        quantity: parseInt(document.getElementById('invQuantity').value),
                        lowStockThreshold: parseInt(document.getElementById('invThreshold').value),
                        storeId: document.getElementById('invStoreId').value
                    })
                });

                const data = await response.json();
                showResponse('inventoryResponse', data, !response.ok);
            } catch (error) {
                showResponse('inventoryResponse', { error: error.message }, true);
            } finally {
                hideLoading(btn, originalText);
            }
        }

        async function getInventory(event) {
            if (!checkAuth()) return;
            const btn = event.target;
            const originalText = btn.innerHTML;

            try {
                showLoading(btn);
                const productCode = document.getElementById('invProductCode').value;
                const response = await fetch(`${BASE_URL}/api/inventory/${productCode}`, {
                    method: 'GET',
                    headers: getHeaders()
                });

                const data = await response.json();
                showResponse('inventoryResponse', data, !response.ok);
            } catch (error) {
                showResponse('inventoryResponse', { error: error.message }, true);
            } finally {
                hideLoading(btn, originalText);
            }
        }

        async function updateInventory(event) {
            if (!checkAuth()) return;
            const btn = event.target;
            const originalText = btn.innerHTML;

            try {
                showLoading(btn);
                const productCode = document.getElementById('invProductCode').value;
                const response = await fetch(`${BASE_URL}/api/inventory/${productCode}`, {
                    method: 'PUT',
                    headers: getHeaders(),
                    body: JSON.stringify({
                        quantity: parseInt(document.getElementById('invQuantity').value),
                        lowStockThreshold: parseInt(document.getElementById('invThreshold').value)
                    })
                });

                const data = await response.json();
                showResponse('inventoryResponse', data, !response.ok);
            } catch (error) {
                showResponse('inventoryResponse', { error: error.message }, true);
            } finally {
                hideLoading(btn, originalText);
            }
        }

        async function checkLowStock(event) {
            if (!checkAuth()) return;
            const btn = event.target;
            const originalText = btn.innerHTML;

            try {
                showLoading(btn);
                const storeId = document.getElementById('lowStockStoreId').value;
                let url = `${BASE_URL}/api/inventory/low-stock`;
                if (storeId) {
                    url += `?storeId=${storeId}`;
                }

                const response = await fetch(url, {
                    method: 'GET',
                    headers: getHeaders()
                });

                const data = await response.json();
                showResponse('inventoryResponse', data, !response.ok);
            } catch (error) {
                showResponse('inventoryResponse', { error: error.message }, true);
            } finally {
                hideLoading(btn, originalText);
            }
        }

        async function reserveItems(event) {
            if (!checkAuth()) return;
            const btn = event.target;
            const originalText = btn.innerHTML;

            try {
                showLoading(btn);
                const productCode = document.getElementById('reserveProductCode').value;
                const response = await fetch(`${BASE_URL}/api/inventory/${productCode}/reserve`, {
                    method: 'POST',
                    headers: getHeaders(),
                    body: JSON.stringify({
                        quantity: parseInt(document.getElementById('reserveQuantity').value),
                        referenceId: document.getElementById('referenceId').value
                    })
                });

                const data = await response.json();
                showResponse('inventoryResponse', data, !response.ok);
            } catch (error) {
                showResponse('inventoryResponse', { error: error.message }, true);
            } finally {
                hideLoading(btn, originalText);
            }
        }

        async function requestFinanceApproval(event) {
            if (!checkAuth()) return;
            const btn = event.target;
            const originalText = btn.innerHTML;

            try {
                showLoading(btn);
                const response = await fetch(`${BASE_URL}/api/finance/approve`, {
                    method: 'POST',
                    headers: getHeaders(),
                    body: JSON.stringify({
                        customerId: document.getElementById('customerId').value,
                        amount: parseFloat(document.getElementById('amount').value),
                        purpose: document.getElementById('purpose').value
                    })
                });

                const data = await response.json();
                showResponse('financeResponse', data, !response.ok);

                // Auto-populate request ID if successful
                if (data.success && data.data && data.data.requestId) {
                    document.getElementById('approvalRequestId').value = data.data.requestId;
                    document.getElementById('checkRequestId').value = data.data.requestId;
                    alert('Request submitted to queue! ID: ' + data.data.requestId + '\nIt will remain in the queue until approved or declined.');
                }
            } catch (error) {
                showResponse('financeResponse', { error: error.message }, true);
            } finally {
                hideLoading(btn, originalText);
            }
        }

        async function viewPendingQueue(event) {
            if (!checkAuth()) return;
            const btn = event.target;
            const originalText = btn.innerHTML;

            try {
                showLoading(btn);
                const response = await fetch(`${BASE_URL}/api/finance/pending`, {
                    method: 'GET',
                    headers: getHeaders()
                });

                const data = await response.json();
                showResponse('financeResponse', data, !response.ok);
            } catch (error) {
                showResponse('financeResponse', { error: error.message }, true);
            } finally {
                hideLoading(btn, originalText);
            }
        }

        async function viewQueueStats(event) {
            if (!checkAuth()) return;
            const btn = event.target;
            const originalText = btn.innerHTML;

            try {
                showLoading(btn);
                const response = await fetch(`${BASE_URL}/api/finance/queue-stats`, {
                    method: 'GET',
                    headers: getHeaders()
                });

                const data = await response.json();
                showResponse('financeResponse', data, !response.ok);
            } catch (error) {
                showResponse('financeResponse', { error: error.message }, true);
            } finally {
                hideLoading(btn, originalText);
            }
        }

        async function approveFinance(event) {
            if (!checkAuth()) return;
            const requestId = document.getElementById('approvalRequestId').value;
            if (!requestId) {
                alert('Please enter a Request ID');
                return;
            }

            const btn = event.target;
            const originalText = btn.innerHTML;

            try {
                showLoading(btn);
                const response = await fetch(`${BASE_URL}/api/finance/approve/${requestId}`, {
                    method: 'PUT',
                    headers: getHeaders(),
                    body: JSON.stringify({
                        approvedBy: 'Manual UI User',
                        notes: 'Manually approved via UI'
                    })
                });

                const data = await response.json();
                showResponse('financeResponse', data, !response.ok);

                if (data.success) {
                    alert('Approval decision queued! The request will be processed and the external finance system will be contacted.\nCheck status after a few seconds.');
                }
            } catch (error) {
                showResponse('financeResponse', { error: error.message }, true);
            } finally {
                hideLoading(btn, originalText);
            }
        }

        async function declineFinance(event) {
            if (!checkAuth()) return;
            const requestId = document.getElementById('approvalRequestId').value;
            if (!requestId) {
                alert('Please enter a Request ID');
                return;
            }

            const btn = event.target;
            const originalText = btn.innerHTML;

            try {
                showLoading(btn);
                const response = await fetch(`${BASE_URL}/api/finance/decline/${requestId}`, {
                    method: 'PUT',
                    headers: getHeaders(),
                    body: JSON.stringify({
                        declinedBy: 'Manual UI User',
                        notes: 'Manually declined via UI'
                    })
                });

                const data = await response.json();
                showResponse('financeResponse', data, !response.ok);

                if (data.success) {
                    alert('Decline decision queued! The request will be processed and marked as rejected.\nCheck status after a few seconds.');
                }
            } catch (error) {
                showResponse('financeResponse', { error: error.message }, true);
            } finally {
                hideLoading(btn, originalText);
            }
        }

        async function checkFinanceStatus(event) {
            if (!checkAuth()) return;
            const requestId = document.getElementById('checkRequestId').value;
            if (!requestId) {
                alert('Please enter a Request ID');
                return;
            }

            const btn = event.target;
            const originalText = btn.innerHTML;

            try {
                showLoading(btn);
                const response = await fetch(`${BASE_URL}/api/finance/status/${requestId}`, {
                    method: 'GET',
                    headers: getHeaders()
                });

                const data = await response.json();
                showResponse('financeResponse', data, !response.ok);
            } catch (error) {
                showResponse('financeResponse', { error: error.message }, true);
            } finally {
                hideLoading(btn, originalText);
            }
        }

        async function viewAllProducts(event) {
            if (!checkAuth()) return;
            const btn = event.target;
            const originalText = btn.innerHTML;

            try {
                showLoading(btn);
                const limit = document.getElementById('productLimit').value;
                const page = document.getElementById('productPage').value || 0;
                const response = await fetch(`${BASE_URL}/api/pricing/products?limit=${limit}&page=${page}`, {
                    method: 'GET',
                    headers: getHeaders()
                });

                const data = await response.json();
                showResponse('viewAllResponse', data, !response.ok);
            } catch (error) {
                showResponse('viewAllResponse', { error: error.message }, true);
            } finally {
                hideLoading(btn, originalText);
            }
        }

        async function viewAllInventory(event) {
            if (!checkAuth()) return;
            const btn = event.target;
            const originalText = btn.innerHTML;

            try {
                showLoading(btn);
                const limit = document.getElementById('inventoryLimit').value;
                const storeId = document.getElementById('storeIdFilter').value;
                let url = `${BASE_URL}/api/inventory?limit=${limit}`;
                if (storeId) {
                    url += `&storeId=${storeId}`;
                }

                const response = await fetch(url, {
                    method: 'GET',
                    headers: getHeaders()
                });

                const data = await response.json();
                showResponse('viewAllResponse', data, !response.ok);
            } catch (error) {
                showResponse('viewAllResponse', { error: error.message }, true);
            } finally {
                hideLoading(btn, originalText);
            }
        }

        async function viewAllPromotions(event) {
            if (!checkAuth()) return;
            const btn = event.target;
            const originalText = btn.innerHTML;

            try {
                showLoading(btn);
                const limit = document.getElementById('promotionLimit').value;
                const response = await fetch(`${BASE_URL}/api/pricing/promotions?limit=${limit}`, {
                    method: 'GET',
                    headers: getHeaders()
                });

                const data = await response.json();
                showResponse('viewAllResponse', data, !response.ok);
            } catch (error) {
                showResponse('viewAllResponse', { error: error.message }, true);
            } finally {
                hideLoading(btn, originalText);
            }
        }

        async function viewAllFinanceRequests(event) {
            if (!checkAuth()) return;
            const btn = event.target;
            const originalText = btn.innerHTML;

            try {
                showLoading(btn);
                const limit = document.getElementById('financeLimit').value;
                const status = document.getElementById('financeStatus').value;
                let url = `${BASE_URL}/api/finance/requests?limit=${limit}`;
                if (status) {
                    url += `&status=${status}`;
                }

                const response = await fetch(url, {
                    method: 'GET',
                    headers: getHeaders()
                });

                const data = await response.json();
                showResponse('viewAllResponse', data, !response.ok);
            } catch (error) {
                showResponse('viewAllResponse', { error: error.message }, true);
            } finally {
                hideLoading(btn, originalText);
            }
        }

        async function testAllAPIs(event) {
            if (!accessToken) {
                alert('Please login first');
                return;
            }

            const btn = event.target;
            const originalText = btn.innerHTML;

            try {
                showLoading(btn);

                // Create a fake event object for sub-calls
                const fakeEvent = { target: btn };

                // Test Pricing Service
                await createProduct(fakeEvent);
                await new Promise(resolve => setTimeout(resolve, 500));
                await createPromotion(fakeEvent);
                await new Promise(resolve => setTimeout(resolve, 500));
                await calculatePrice(fakeEvent);
                await new Promise(resolve => setTimeout(resolve, 500));

                // Test Inventory Service
                await createInventory(fakeEvent);
                await new Promise(resolve => setTimeout(resolve, 500));
                await getInventory(fakeEvent);
                await new Promise(resolve => setTimeout(resolve, 500));
                await reserveItems(fakeEvent);
                await new Promise(resolve => setTimeout(resolve, 500));

                // Test Finance Service
                await requestFinanceApproval(fakeEvent);

                alert('All API tests completed. Check the response sections for details.');
            } catch (error) {
                alert('Error during testing: ' + error.message);
            } finally {
                hideLoading(btn, originalText);
            }
        }

        function toggleView(elementId, viewType) {
            const element = document.getElementById(elementId);
            const data = responseData[elementId];

            if (!data) return;

            // Update toggle buttons
            const jsonBtn = document.getElementById(elementId + '-json-btn');
            const tableBtn = document.getElementById(elementId + '-table-btn');

            if (viewType === 'json') {
                jsonBtn.className = 'active';
                tableBtn.className = '';
                element.innerHTML = '';
                element.textContent = JSON.stringify(data, null, 2);
            } else {
                jsonBtn.className = '';
                tableBtn.className = 'active';
                element.innerHTML = renderTable(data);
            }
        }

        function renderTable(data, level = 0) {
            if (data === null) return '<span class="value-null">null</span>';
            if (data === undefined) return '<span class="value-null">undefined</span>';

            const type = typeof data;

            if (type === 'string') return `<span class="value-string">"${escapeHtml(data)}"</span>`;
            if (type === 'number') return `<span class="value-number">${data}</span>`;
            if (type === 'boolean') return `<span class="value-boolean">${data}</span>`;

            if (Array.isArray(data)) {
                if (data.length === 0) return '<span class="value-null">[]</span>';

                // Check if array contains objects with similar structure
                if (data.every(item => typeof item === 'object' && item !== null && !Array.isArray(item))) {
                    return renderArrayAsTable(data);
                }

                // Render as collapsible list
                let html = `<div class="collapsible" onclick="toggleCollapse(this)">Array [${data.length}]</div>`;
                html += '<div class="nested-content">';
                data.forEach((item, index) => {
                    html += `<div><span class="key-label">[${index}]:</span> ${renderTable(item, level + 1)}</div>`;
                });
                html += '</div>';
                return html;
            }

            if (type === 'object') {
                const keys = Object.keys(data);
                if (keys.length === 0) return '<span class="value-null">{}</span>';

                let html = `<div class="collapsible" onclick="toggleCollapse(this)">Object {${keys.length}}</div>`;
                html += '<div class="nested-content">';
                keys.forEach(key => {
                    html += `<div><span class="key-label">${escapeHtml(key)}:</span> ${renderTable(data[key], level + 1)}</div>`;
                });
                html += '</div>';
                return html;
            }

            return String(data);
        }

        function renderArrayAsTable(array) {
            if (array.length === 0) return '<span class="value-null">[]</span>';

            // Get all unique keys from all objects
            const keys = [...new Set(array.flatMap(obj => Object.keys(obj)))];

            let html = '<table class="table-view">';
            html += '<thead><tr>';
            keys.forEach(key => {
                html += `<th>${escapeHtml(key)}</th>`;
            });
            html += '</tr></thead><tbody>';

            array.forEach(obj => {
                html += '<tr>';
                keys.forEach(key => {
                    const value = obj[key];
                    let cellContent;

                    if (value === null || value === undefined) {
                        cellContent = '<span class="value-null">null</span>';
                    } else if (typeof value === 'object') {
                        cellContent = renderTable(value);
                    } else if (typeof value === 'string') {
                        cellContent = `<span class="value-string">${escapeHtml(value)}</span>`;
                    } else if (typeof value === 'number') {
                        cellContent = `<span class="value-number">${value}</span>`;
                    } else if (typeof value === 'boolean') {
                        cellContent = `<span class="value-boolean">${value}</span>`;
                    } else {
                        cellContent = escapeHtml(String(value));
                    }

                    html += `<td>${cellContent}</td>`;
                });
                html += '</tr>';
            });

            html += '</tbody></table>';
            return html;
        }

        function toggleCollapse(element) {
            element.classList.toggle('collapsed');
            const content = element.nextElementSibling;
            if (content) {
                content.classList.toggle('collapsed');
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function clearAllResponses() {
            const responseAreas = ['pricingResponse', 'inventoryResponse', 'financeResponse', 'viewAllResponse'];
            responseAreas.forEach(id => {
                const element = document.getElementById(id);
                const header = document.getElementById(id + 'Header');
                if (element) {
                    element.style.display = 'none';
                    element.textContent = '';
                    element.innerHTML = '';
                    element.className = 'response-area';
                }
                if (header) {
                    header.style.display = 'none';
                }
                delete responseData[id];
            });
            alert('All responses cleared');
        }

        function exportResponses() {
            const responseAreas = ['pricingResponse', 'inventoryResponse', 'financeResponse', 'viewAllResponse'];
            const exportData = {
                exportDate: new Date().toISOString(),
                responses: {}
            };

            responseAreas.forEach(id => {
                const element = document.getElementById(id);
                if (element && element.textContent) {
                    try {
                        exportData.responses[id] = JSON.parse(element.textContent);
                    } catch (e) {
                        exportData.responses[id] = element.textContent;
                    }
                }
            });

            const dataStr = JSON.stringify(exportData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `api-test-results-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }
    </script>
</body>

</html>