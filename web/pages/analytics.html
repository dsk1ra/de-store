<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics & Reports - DE-Store</title>
    <link rel="stylesheet" href="../assets/css/styles.css">
</head>

<body>
    <div class="header">
        <div class="header-left">
            <button class="back-btn" onclick="goToDashboard()">← Dashboard</button>
            <h1>Analytics & Reports</h1>
        </div>
        <div class="user-info">
            <span class="user-name" id="userName">Loading...</span>
            <button class="logout-btn" onclick="handleLogout()">Logout</button>
        </div>
    </div>

    <div class="container">
        <div class="page-section">
            <h2>Key Metrics Dashboard</h2>
            <p class="section-description">Track purchase activities and analyze store performance</p>

            <!-- Key Metrics -->
            <div class="metrics-grid" id="metricsGrid">
                <div class="metric-card">
                    <h3>Total Revenue</h3>
                    <div class="metric-value" id="totalRevenue">£0</div>
                </div>
                <div class="metric-card">
                    <h3>Transactions</h3>
                    <div class="metric-value" id="totalTransactions">0</div>
                </div>
                <div class="metric-card">
                    <h3>Avg Transaction</h3>
                    <div class="metric-value" id="avgTransaction">£0</div>
                </div>
                <div class="metric-card">
                    <h3>Customers</h3>
                    <div class="metric-value" id="totalCustomers">0</div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="quick-actions">
                <button class="btn btn-primary active" onclick="loadTodayData()">Today</button>
                <button class="btn btn-secondary" onclick="loadWeekData()">This Week</button>
                <button class="btn btn-secondary" onclick="loadMonthData()">This Month</button>
                <button class="btn btn-secondary" onclick="loadCustomRange()">Custom Range</button>
            </div>
        </div>

        <!-- Sales Report Section -->
        <div class="page-section">
            <h2>Sales Report</h2>
            <p class="section-description">Generate sales reports for custom date ranges</p>
            <div class="form-grid" style="margin-bottom: 20px;">
                <div class="form-group">
                    <label for="startDate">Start Date</label>
                    <input type="date" id="startDate" />
                </div>
                <div class="form-group">
                    <label for="endDate">End Date</label>
                    <input type="date" id="endDate" />
                </div>
                <div class="form-actions">
                    <button class="btn btn-primary" onclick="generateSalesReport()">Generate Report</button>
                </div>
            </div>
            <div id="salesReportContent" class="sales-report-placeholder">
                <div class="placeholder-content">
                    <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 17H7A5 5 0 0 1 7 7h2M15 7h2a5 5 0 1 1 0 10h-2m-8-5h12" />
                    </svg>
                    <p>Select date range and click "Generate Report"</p>
                </div>
            </div>
        </div>

        <!-- Top Products Section -->
        <div class="page-section">
            <h2>Top Selling Products</h2>
            <p class="section-description">View the best performing products</p>
            <div id="topProductsContent">
                <table id="topProductsTable">
                    <thead>
                        <tr>
                            <th>Rank</th>
                            <th>Product Code</th>
                            <th>Quantity Sold</th>
                            <th>Revenue</th>
                            <th>Avg Price</th>
                            <th>Transactions</th>
                        </tr>
                    </thead>
                    <tbody id="topProductsBody">
                        <tr>
                            <td colspan="6" style="text-align: center; padding: 40px;">
                                Loading top products...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Top Customers Section -->
        <div class="page-section">
            <h2>Top Customers</h2>
            <p class="section-description">View the most valuable customers</p>
            <div id="topCustomersContent">
                <table id="topCustomersTable">
                    <thead>
                        <tr>
                            <th>Rank</th>
                            <th>Customer ID</th>
                            <th>Total Purchases</th>
                            <th>Total Spent</th>
                            <th>Avg Order Value</th>
                            <th>Last Purchase</th>
                        </tr>
                    </thead>
                    <tbody id="topCustomersBody">
                        <tr>
                            <td colspan="6" style="text-align: center; padding: 40px;">
                                Loading top customers...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Store Performance Section -->
        <div class="page-section">
            <h2>Store Performance</h2>
            <p class="section-description">View performance metrics by store</p>
            <div id="storePerformanceContent">
                <table id="storePerformanceTable">
                    <thead>
                        <tr>
                            <th>Store ID</th>
                            <th>Total Revenue</th>
                            <th>Transactions</th>
                            <th>Avg Order Value</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="storePerformanceBody">
                        <tr>
                            <td colspan="5" style="text-align: center; padding: 40px;">
                                Loading store performance data...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8087/analytics';

        // Initialize dates to today
        window.onload = function () {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('startDate').value = today;
            document.getElementById('endDate').value = today;
            loadTodayData();
        };

        function loadTodayData() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('startDate').value = today;
            document.getElementById('endDate').value = today;
            generateSalesReport();
            loadTopProducts();
            loadTopCustomers();
            loadStorePerformance();
        }

        function loadWeekData() {
            const today = new Date();
            const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
            document.getElementById('startDate').value = weekAgo.toISOString().split('T')[0];
            document.getElementById('endDate').value = today.toISOString().split('T')[0];
            generateSalesReport();
        }

        function loadMonthData() {
            const today = new Date();
            const monthAgo = new Date(today.getTime() - 30 * 24 * 60 * 60 * 1000);
            document.getElementById('startDate').value = monthAgo.toISOString().split('T')[0];
            document.getElementById('endDate').value = today.toISOString().split('T')[0];
            generateSalesReport();
        }

        async function generateSalesReport() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;

            if (!startDate || !endDate) {
                alert('Please select both start and end dates');
                return;
            }

            const content = document.getElementById('salesReportContent');
            content.innerHTML = '<div class="report-loading"><div class="spinner"></div><p>Generating report...</p></div>';

            try {
                const response = await fetch(
                    `${API_BASE}/reports/sales?startDate=${startDate}&endDate=${endDate}`
                );

                if (!response.ok) {
                    throw new Error('Failed to fetch sales report');
                }

                const report = await response.json();

                // Update metrics
                document.getElementById('totalRevenue').textContent =
                    '£' + (report.totalSales || 0).toFixed(2);
                document.getElementById('totalTransactions').textContent =
                    report.transactionCount || 0;
                document.getElementById('avgTransaction').textContent =
                    '£' + (report.averageTransactionValue || 0).toFixed(2);
                document.getElementById('totalCustomers').textContent =
                    report.customerCount || 0;

                // Display detailed report
                content.innerHTML = `
                    <div class="report-header">
                        <div class="report-period">
                            <span class="period-label">Report Period</span>
                            <span class="period-value">${report.startDate} to ${report.endDate}</span>
                        </div>
                    </div>
                    <table class="report-table">
                        <tbody>
                            <tr class="highlight-row">
                                <td class="report-label">Net Revenue</td>
                                <td class="report-value">£${(report.netRevenue || 0).toFixed(2)}</td>
                            </tr>
                            <tr>
                                <td class="report-label">Total Sales</td>
                                <td class="report-value">£${(report.totalSales || 0).toFixed(2)}</td>
                            </tr>
                            <tr>
                                <td class="report-label">Total Discounts</td>
                                <td class="report-value">£${(report.totalDiscounts || 0).toFixed(2)}</td>
                            </tr>
                            <tr>
                                <td class="report-label">Transactions</td>
                                <td class="report-value">${report.transactionCount || 0}</td>
                            </tr>
                            <tr>
                                <td class="report-label">Avg Transaction</td>
                                <td class="report-value">£${(report.averageTransactionValue || 0).toFixed(2)}</td>
                            </tr>
                            <tr>
                                <td class="report-label">Unique Customers</td>
                                <td class="report-value">${report.customerCount || 0}</td>
                            </tr>
                        </tbody>
                    </table>
                `;
            } catch (error) {
                content.innerHTML = `
                    <div class="error-container">
                        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"></circle>
                            <line x1="12" y1="8" x2="12" y2="12"></line>
                            <line x1="12" y1="16" x2="12.01" y2="16"></line>
                        </svg>
                        <p class="error">Error: ${error.message}</p>
                    </div>
                `;
            }
        }

        async function loadTopProducts() {
            const today = new Date().toISOString().split('T')[0];
            const tbody = document.getElementById('topProductsBody');

            try {
                const response = await fetch(
                    `${API_BASE}/products/top?reportDate=${today}&limit=10`
                );

                if (!response.ok) {
                    throw new Error('Failed to fetch top products');
                }

                const products = await response.json();

                if (products.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 40px;">No products data available for today</td></tr>';
                    return;
                }

                tbody.innerHTML = products.map((product, index) => {
                    let rankClass = '';
                    if (index === 0) rankClass = 'gold';
                    else if (index === 1) rankClass = 'silver';
                    else if (index === 2) rankClass = 'bronze';

                    return `
                        <tr>
                            <td><span class="rank ${rankClass}">${index + 1}</span></td>
                            <td>${product.productCode}</td>
                            <td>${product.quantitySold || 0}</td>
                            <td>£${(product.totalRevenue || 0).toFixed(2)}</td>
                            <td>£${(product.averagePrice || 0).toFixed(2)}</td>
                            <td>${product.transactionCount || 0}</td>
                        </tr>
                    `;
                }).join('');
            } catch (error) {
                tbody.innerHTML = `<tr><td colspan="6" class="error">Error: ${error.message}</td></tr>`;
            }
        }

        async function loadTopCustomers() {
            const today = new Date().toISOString().split('T')[0];
            const tbody = document.getElementById('topCustomersBody');

            try {
                const response = await fetch(
                    `${API_BASE}/customers/top?reportDate=${today}&limit=10`
                );

                if (!response.ok) {
                    throw new Error('Failed to fetch top customers');
                }

                const customers = await response.json();

                if (customers.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 40px;">No customer data available for today</td></tr>';
                    return;
                }

                tbody.innerHTML = customers.map((customer, index) => {
                    let rankClass = '';
                    if (index === 0) rankClass = 'gold';
                    else if (index === 1) rankClass = 'silver';
                    else if (index === 2) rankClass = 'bronze';

                    return `
                        <tr>
                            <td><span class="rank ${rankClass}">${index + 1}</span></td>
                            <td>${customer.customerId}</td>
                            <td>${customer.totalPurchases || 0}</td>
                            <td>£${(customer.totalSpent || 0).toFixed(2)}</td>
                            <td>£${(customer.averageOrderValue || 0).toFixed(2)}</td>
                            <td>${customer.lastPurchaseDate || 'N/A'}</td>
                        </tr>
                    `;
                }).join('');
            } catch (error) {
                tbody.innerHTML = `<tr><td colspan="6" class="error">Error: ${error.message}</td></tr>`;
            }
        }

        async function loadStorePerformance() {
            const today = new Date().toISOString().split('T')[0];
            const tbody = document.getElementById('storePerformanceBody');

            try {
                const response = await fetch(
                    `${API_BASE}/reports/performance?reportDate=${today}`
                );

                if (!response.ok) {
                    throw new Error('Failed to fetch store performance');
                }

                const stores = await response.json();

                if (stores.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 40px;">No store performance data available for today</td></tr>';
                    return;
                }

                tbody.innerHTML = stores.map(store => `
                    <tr>
                        <td>${store.storeId}</td>
                        <td>£${(store.totalRevenue || 0).toFixed(2)}</td>
                        <td>${store.orderCount || 0}</td>
                        <td>£${(store.averageOrderValue || 0).toFixed(2)}</td>
                        <td><span class="status-active">● ${store.status}</span></td>
                    </tr>
                `).join('');
            } catch (error) {
                tbody.innerHTML = `<tr><td colspan="5" class="error">Error: ${error.message}</td></tr>`;
            }
        }

        function loadCustomRange() {
            // User can manually select dates and click Generate Report
            alert('Please select your custom date range and click "Generate Report"');
        }

        function goToDashboard() {
            window.location.href = '../pages/dashboard.html';
        }

        function handleLogout() {
            localStorage.removeItem('token');
            localStorage.removeItem('username');
            window.location.href = '../login.html';
        }

        // Load username if logged in
        const username = localStorage.getItem('username');
        if (username) {
            document.getElementById('userName').textContent = username;
        } else {
            document.getElementById('userName').textContent = 'Guest';
        }
    </script>
</body>

</html>