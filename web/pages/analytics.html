<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics & Reports - DE-Store</title>
    <link rel="stylesheet" href="../assets/style.css">
    <style>
        .analytics-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .dashboard-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .metric-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .metric-card h3 {
            color: #666;
            font-size: 14px;
            margin-bottom: 10px;
            text-transform: uppercase;
        }

        .metric-value {
            font-size: 32px;
            font-weight: bold;
            color: #3498db;
        }

        .metric-change {
            font-size: 12px;
            margin-top: 5px;
        }

        .metric-change.positive {
            color: #27ae60;
        }

        .metric-change.negative {
            color: #e74c3c;
        }

        .report-section {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .report-section h2 {
            margin-bottom: 20px;
            color: #2c3e50;
        }

        .date-filter {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .date-filter input,
        .date-filter button {
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .date-filter button {
            background: #3498db;
            color: white;
            cursor: pointer;
            border: none;
        }

        .date-filter button:hover {
            background: #2980b9;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        table th,
        table td {
            text-align: left;
            padding: 12px;
            border-bottom: 1px solid #eee;
        }

        table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #2c3e50;
        }

        table tr:hover {
            background: #f8f9fa;
        }

        .chart-container {
            margin-top: 20px;
            min-height: 300px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .error {
            color: #e74c3c;
            padding: 15px;
            background: #fee;
            border-radius: 5px;
            margin: 10px 0;
        }

        .success {
            color: #27ae60;
            padding: 15px;
            background: #efe;
            border-radius: 5px;
            margin: 10px 0;
        }

        .rank {
            display: inline-block;
            width: 30px;
            height: 30px;
            line-height: 30px;
            border-radius: 50%;
            background: #3498db;
            color: white;
            font-weight: bold;
            text-align: center;
            margin-right: 10px;
        }

        .rank.gold {
            background: #f39c12;
        }

        .rank.silver {
            background: #95a5a6;
        }

        .rank.bronze {
            background: #cd7f32;
        }

        .quick-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .quick-actions button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            background: #ecf0f1;
            color: #2c3e50;
        }

        .quick-actions button.active {
            background: #3498db;
            color: white;
        }
    </style>
</head>

<body>
    <div class="analytics-container">
        <div class="dashboard-header">
            <h1>üìä Analytics & Reports Dashboard</h1>
            <p>Track purchase activities and analyze store performance</p>
        </div>

        <!-- Key Metrics -->
        <div class="metrics-grid" id="metricsGrid">
            <div class="metric-card">
                <h3>Total Revenue</h3>
                <div class="metric-value" id="totalRevenue">$0</div>
                <div class="metric-change positive">Loading...</div>
            </div>
            <div class="metric-card">
                <h3>Transactions</h3>
                <div class="metric-value" id="totalTransactions">0</div>
                <div class="metric-change">Loading...</div>
            </div>
            <div class="metric-card">
                <h3>Avg Transaction</h3>
                <div class="metric-value" id="avgTransaction">$0</div>
                <div class="metric-change">Loading...</div>
            </div>
            <div class="metric-card">
                <h3>Customers</h3>
                <div class="metric-value" id="totalCustomers">0</div>
                <div class="metric-change">Loading...</div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="quick-actions">
            <button onclick="loadTodayData()" class="active">Today</button>
            <button onclick="loadWeekData()">This Week</button>
            <button onclick="loadMonthData()">This Month</button>
            <button onclick="loadCustomRange()">Custom Range</button>
        </div>

        <!-- Sales Report Section -->
        <div class="report-section">
            <h2>üìà Sales Report</h2>
            <div class="date-filter">
                <input type="date" id="startDate" />
                <input type="date" id="endDate" />
                <button onclick="generateSalesReport()">Generate Report</button>
            </div>
            <div id="salesReportContent" class="loading">
                <p>Select date range and click "Generate Report"</p>
            </div>
        </div>

        <!-- Top Products Section -->
        <div class="report-section">
            <h2>üèÜ Top Selling Products</h2>
            <div id="topProductsContent">
                <table id="topProductsTable">
                    <thead>
                        <tr>
                            <th>Rank</th>
                            <th>Product Code</th>
                            <th>Quantity Sold</th>
                            <th>Revenue</th>
                            <th>Avg Price</th>
                            <th>Transactions</th>
                        </tr>
                    </thead>
                    <tbody id="topProductsBody">
                        <tr>
                            <td colspan="6" style="text-align: center; padding: 40px;">
                                Loading top products...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Top Customers Section -->
        <div class="report-section">
            <h2>üë• Top Customers</h2>
            <div id="topCustomersContent">
                <table id="topCustomersTable">
                    <thead>
                        <tr>
                            <th>Rank</th>
                            <th>Customer ID</th>
                            <th>Total Purchases</th>
                            <th>Total Spent</th>
                            <th>Avg Order Value</th>
                            <th>Last Purchase</th>
                        </tr>
                    </thead>
                    <tbody id="topCustomersBody">
                        <tr>
                            <td colspan="6" style="text-align: center; padding: 40px;">
                                Loading top customers...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Store Performance Section -->
        <div class="report-section">
            <h2>üè™ Store Performance</h2>
            <div id="storePerformanceContent">
                <table id="storePerformanceTable">
                    <thead>
                        <tr>
                            <th>Store ID</th>
                            <th>Total Revenue</th>
                            <th>Transactions</th>
                            <th>Avg Order Value</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="storePerformanceBody">
                        <tr>
                            <td colspan="5" style="text-align: center; padding: 40px;">
                                Loading store performance data...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8087/analytics';

        // Initialize dates to today
        window.onload = function () {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('startDate').value = today;
            document.getElementById('endDate').value = today;
            loadTodayData();
        };

        function loadTodayData() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('startDate').value = today;
            document.getElementById('endDate').value = today;
            generateSalesReport();
            loadTopProducts();
            loadTopCustomers();
            loadStorePerformance();
        }

        function loadWeekData() {
            const today = new Date();
            const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
            document.getElementById('startDate').value = weekAgo.toISOString().split('T')[0];
            document.getElementById('endDate').value = today.toISOString().split('T')[0];
            generateSalesReport();
        }

        function loadMonthData() {
            const today = new Date();
            const monthAgo = new Date(today.getTime() - 30 * 24 * 60 * 60 * 1000);
            document.getElementById('startDate').value = monthAgo.toISOString().split('T')[0];
            document.getElementById('endDate').value = today.toISOString().split('T')[0];
            generateSalesReport();
        }

        async function generateSalesReport() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;

            if (!startDate || !endDate) {
                alert('Please select both start and end dates');
                return;
            }

            const content = document.getElementById('salesReportContent');
            content.innerHTML = '<p class="loading">Generating report...</p>';

            try {
                const response = await fetch(
                    `${API_BASE}/reports/sales?startDate=${startDate}&endDate=${endDate}`
                );

                if (!response.ok) {
                    throw new Error('Failed to fetch sales report');
                }

                const report = await response.json();

                // Update metrics
                document.getElementById('totalRevenue').textContent =
                    '$' + (report.totalSales || 0).toFixed(2);
                document.getElementById('totalTransactions').textContent =
                    report.transactionCount || 0;
                document.getElementById('avgTransaction').textContent =
                    '$' + (report.averageTransactionValue || 0).toFixed(2);
                document.getElementById('totalCustomers').textContent =
                    report.customerCount || 0;

                // Display detailed report
                content.innerHTML = `
                    <table>
                        <tr>
                            <th>Metric</th>
                            <th>Value</th>
                        </tr>
                        <tr>
                            <td>Report Period</td>
                            <td>${report.startDate} to ${report.endDate}</td>
                        </tr>
                        <tr>
                            <td>Total Sales</td>
                            <td>$${(report.totalSales || 0).toFixed(2)}</td>
                        </tr>
                        <tr>
                            <td>Total Discounts</td>
                            <td>$${(report.totalDiscounts || 0).toFixed(2)}</td>
                        </tr>
                        <tr>
                            <td>Net Revenue</td>
                            <td><strong>$${(report.netRevenue || 0).toFixed(2)}</strong></td>
                        </tr>
                        <tr>
                            <td>Number of Transactions</td>
                            <td>${report.transactionCount || 0}</td>
                        </tr>
                        <tr>
                            <td>Average Transaction Value</td>
                            <td>$${(report.averageTransactionValue || 0).toFixed(2)}</td>
                        </tr>
                        <tr>
                            <td>Unique Customers</td>
                            <td>${report.customerCount || 0}</td>
                        </tr>
                    </table>
                `;
            } catch (error) {
                content.innerHTML = `<p class="error">Error: ${error.message}</p>`;
            }
        }

        async function loadTopProducts() {
            const today = new Date().toISOString().split('T')[0];
            const tbody = document.getElementById('topProductsBody');

            try {
                const response = await fetch(
                    `${API_BASE}/products/top?reportDate=${today}&limit=10`
                );

                if (!response.ok) {
                    throw new Error('Failed to fetch top products');
                }

                const products = await response.json();

                if (products.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 40px;">No products data available for today</td></tr>';
                    return;
                }

                tbody.innerHTML = products.map((product, index) => {
                    let rankClass = '';
                    if (index === 0) rankClass = 'gold';
                    else if (index === 1) rankClass = 'silver';
                    else if (index === 2) rankClass = 'bronze';

                    return `
                        <tr>
                            <td><span class="rank ${rankClass}">${index + 1}</span></td>
                            <td>${product.productCode}</td>
                            <td>${product.quantitySold || 0}</td>
                            <td>$${(product.totalRevenue || 0).toFixed(2)}</td>
                            <td>$${(product.averagePrice || 0).toFixed(2)}</td>
                            <td>${product.transactionCount || 0}</td>
                        </tr>
                    `;
                }).join('');
            } catch (error) {
                tbody.innerHTML = `<tr><td colspan="6" class="error">Error: ${error.message}</td></tr>`;
            }
        }

        async function loadTopCustomers() {
            const today = new Date().toISOString().split('T')[0];
            const tbody = document.getElementById('topCustomersBody');

            try {
                const response = await fetch(
                    `${API_BASE}/customers/top?reportDate=${today}&limit=10`
                );

                if (!response.ok) {
                    throw new Error('Failed to fetch top customers');
                }

                const customers = await response.json();

                if (customers.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 40px;">No customer data available for today</td></tr>';
                    return;
                }

                tbody.innerHTML = customers.map((customer, index) => {
                    let rankClass = '';
                    if (index === 0) rankClass = 'gold';
                    else if (index === 1) rankClass = 'silver';
                    else if (index === 2) rankClass = 'bronze';

                    return `
                        <tr>
                            <td><span class="rank ${rankClass}">${index + 1}</span></td>
                            <td>${customer.customerId}</td>
                            <td>${customer.totalPurchases || 0}</td>
                            <td>$${(customer.totalSpent || 0).toFixed(2)}</td>
                            <td>$${(customer.averageOrderValue || 0).toFixed(2)}</td>
                            <td>${customer.lastPurchaseDate || 'N/A'}</td>
                        </tr>
                    `;
                }).join('');
            } catch (error) {
                tbody.innerHTML = `<tr><td colspan="6" class="error">Error: ${error.message}</td></tr>`;
            }
        }

        async function loadStorePerformance() {
            const today = new Date().toISOString().split('T')[0];
            const tbody = document.getElementById('storePerformanceBody');

            try {
                const response = await fetch(
                    `${API_BASE}/reports/performance?reportDate=${today}`
                );

                if (!response.ok) {
                    throw new Error('Failed to fetch store performance');
                }

                const stores = await response.json();

                if (stores.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 40px;">No store performance data available for today</td></tr>';
                    return;
                }

                tbody.innerHTML = stores.map(store => `
                    <tr>
                        <td>${store.storeId}</td>
                        <td>$${(store.totalRevenue || 0).toFixed(2)}</td>
                        <td>${store.totalTransactions || 0}</td>
                        <td>$${(store.averageOrderValue || 0).toFixed(2)}</td>
                        <td><span style="color: #27ae60;">‚óè ${store.status}</span></td>
                    </tr>
                `).join('');
            } catch (error) {
                tbody.innerHTML = `<tr><td colspan="5" class="error">Error: ${error.message}</td></tr>`;
            }
        }
    </script>
</body>

</html>