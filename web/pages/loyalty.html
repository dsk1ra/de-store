<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DE-Store - Loyalty Service</title>
    <link rel="stylesheet" href="../assets/css/styles.css">
</head>

<body>
    <div class="header">
        <div class="header-left">
            <button class="back-btn" onclick="goToDashboard()">← Dashboard</button>
            <h1>Loyalty Service</h1>
        </div>
        <div class="user-info">
            <span class="user-name" id="userName">Loading...</span>
            <button class="logout-btn" onclick="handleLogout()">Logout</button>
        </div>
    </div>

    <div class="container">
        <!-- Customer Registration Section -->
        <div class="page-section">
            <h2>Customer Registration</h2>
            <p class="section-description">Register new customers for the loyalty program</p>

            <form class="form-grid" onsubmit="registerCustomer(event)">
                <div class="form-group">
                    <label for="customerId">Customer ID</label>
                    <input type="text" id="customerId" placeholder="CUST-001" pattern="CUST-\\d{3,}" required>
                    <small class="form-hint">Format: CUST-XXX</small>
                </div>

                <div class="form-group">
                    <label for="customerName">Name</label>
                    <input type="text" id="customerName" placeholder="Customer Name" required>
                </div>

                <div class="form-group">
                    <label for="customerEmail">Email</label>
                    <input type="email" id="customerEmail" placeholder="customer@example.com" required>
                </div>

                <div class="form-group">
                    <label for="customerPhone">Phone</label>
                    <input type="tel" id="customerPhone" placeholder="+1234567890">
                </div>

                <div class="form-group full-width">
                    <label for="customerAddress">Address</label>
                    <input type="text" id="customerAddress" placeholder="Customer Address">
                </div>

                <div class="form-actions full-width">
                    <button type="submit" class="btn btn-success">Register Customer</button>
                    <button type="button" class="btn btn-primary" onclick="getCustomer(event)">Get Customer</button>
                    <button type="button" class="btn btn-secondary" onclick="getAllCustomers(event)">Get All
                        Customers</button>
                </div>
            </form>

            <div id="customerResponse" class="response-area" style="display:none;"></div>
        </div>

        <!-- Customer Lookup Section -->
        <div class="page-section">
            <h2>Customer Lookup</h2>
            <p class="section-description">View customer loyalty details and discount</p>

            <div class="form-grid">
                <div class="form-group">
                    <label for="lookupCustomerId">Customer ID</label>
                    <input type="text" id="lookupCustomerId" placeholder="CUST-001">
                </div>

                <div class="form-actions">
                    <button class="btn btn-primary" onclick="lookupCustomer(event)">Lookup</button>
                    <button class="btn btn-secondary" onclick="getCustomerDiscount(event)">Get Discount</button>
                </div>
            </div>

            <div id="lookupResponse" class="response-area" style="display:none;"></div>
        </div>

        <!-- Record Purchase Section -->
        <div class="page-section">
            <h2>Record Purchase</h2>
            <p class="section-description">Record a purchase and earn loyalty points</p>

            <form class="form-grid" onsubmit="recordPurchase(event)">
                <div class="form-group">
                    <label for="purchaseCustomerId">Customer ID</label>
                    <input type="text" id="purchaseCustomerId" placeholder="CUST-001" required>
                </div>

                <div class="form-group">
                    <label for="orderId">Order ID</label>
                    <input type="text" id="orderId" placeholder="ORDER-12345" required>
                </div>

                <div class="form-group">
                    <label for="purchaseAmount">Amount (£)</label>
                    <input type="number" id="purchaseAmount" placeholder="100.00" step="0.01" min="0.01" required>
                </div>

                <div class="form-group full-width">
                    <label for="purchaseItems">Items (Optional)</label>
                    <input type="text" id="purchaseItems" placeholder="Item details">
                </div>

                <div class="form-actions full-width">
                    <button type="submit" class="btn btn-success">Record Purchase</button>
                    <button type="button" class="btn btn-secondary" onclick="getPurchaseHistory(event)">View Purchase
                        History</button>
                </div>
            </form>

            <div id="purchaseResponse" class="response-area" style="display:none;"></div>
        </div>

        <!-- Regular Customers Section -->
        <div class="page-section">
            <h2>Regular Customers</h2>
            <p class="section-description">View customers who regularly use the store (3+ purchases)</p>

            <div class="form-actions">
                <button class="btn btn-primary" onclick="getRegularCustomers(event)">Get Regular Customers</button>
                <button class="btn btn-secondary" onclick="getActiveCustomers(event)">Get Active Customers</button>
            </div>

            <div id="regularCustomersResponse" class="response-area" style="display:none;"></div>
        </div>

        <!-- Loyalty Tier Filter Section -->
        <div class="page-section">
            <h2>Customers by Tier</h2>
            <p class="section-description">Filter customers by loyalty tier (Bronze: 0-999, Silver: 1000-4999, Gold:
                5000+)</p>

            <div class="form-grid">
                <div class="form-group">
                    <label for="tierSelect">Loyalty Tier</label>
                    <select id="tierSelect">
                        <option value="BRONZE">Bronze (0-999 points)</option>
                        <option value="SILVER">Silver (1000-4999 points)</option>
                        <option value="GOLD">Gold (5000+ points)</option>
                    </select>
                </div>

                <div class="form-actions">
                    <button class="btn btn-primary" onclick="getCustomersByTier(event)">Get Customers</button>
                </div>
            </div>

            <div id="tierResponse" class="response-area" style="display:none;"></div>
        </div>

        <!-- Create Loyalty Promotion Section -->
        <div class="page-section">
            <h2>Create Loyalty Promotion</h2>
            <p class="section-description">Create special offers for loyalty program members</p>

            <form class="form-grid" onsubmit="createLoyaltyPromotion(event)">
                <div class="form-group">
                    <label for="promoCode">Promotion Code</label>
                    <input type="text" id="promoCode" placeholder="LOYALTY2024" required>
                </div>

                <div class="form-group">
                    <label for="promoName">Promotion Name</label>
                    <input type="text" id="promoName" placeholder="Gold Member Exclusive" required>
                </div>

                <div class="form-group full-width">
                    <label for="promoDescription">Description</label>
                    <input type="text" id="promoDescription" placeholder="Special discount for Gold tier members">
                </div>

                <div class="form-group">
                    <label for="minTier">Minimum Tier</label>
                    <select id="minTier" required>
                        <option value="BRONZE">Bronze</option>
                        <option value="SILVER">Silver</option>
                        <option value="GOLD">Gold</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="discountPercent">Discount (%)</label>
                    <input type="number" id="discountPercent" placeholder="15" min="1" max="100" required>
                </div>

                <div class="form-group">
                    <label for="pointsCost">Points Cost</label>
                    <input type="number" id="pointsCost" placeholder="500" min="0" required>
                </div>

                <div class="form-group">
                    <label for="startDate">Start Date</label>
                    <input type="datetime-local" id="startDate" required>
                </div>

                <div class="form-group">
                    <label for="endDate">End Date</label>
                    <input type="datetime-local" id="endDate" required>
                </div>

                <div class="form-actions full-width">
                    <button type="submit" class="btn btn-success">Create Promotion</button>
                    <button type="button" class="btn btn-primary" onclick="getActivePromotions(event)">View Active
                        Promotions</button>
                </div>
            </form>

            <div id="promotionResponse" class="response-area" style="display:none;"></div>
        </div>
    </div>

    <script src="../assets/js/auth.js"></script>
    <script>
        const API_BASE_URL = 'http://localhost:8080';

        // Register Customer
        async function registerCustomer(event) {
            event.preventDefault();

            const requestBody = {
                customerId: document.getElementById('customerId').value,
                name: document.getElementById('customerName').value,
                email: document.getElementById('customerEmail').value,
                phone: document.getElementById('customerPhone').value || null,
                address: document.getElementById('customerAddress').value || null
            };

            try {
                const response = await fetch(`${API_BASE_URL}/api/loyalty/customers`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${getToken()}`
                    },
                    body: JSON.stringify(requestBody)
                });

                const data = await response.json();
                showResponse('customerResponse', data, !response.ok);

                if (response.ok) {
                    event.target.reset();
                }
            } catch (error) {
                showResponse('customerResponse', { success: false, message: error.message }, true);
            }
        }

        // Get Customer
        async function getCustomer(event) {
            event.preventDefault();
            const customerId = document.getElementById('customerId').value;

            if (!customerId) {
                showResponse('customerResponse', { success: false, message: 'Please enter a customer ID' }, true);
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/api/loyalty/customers/${customerId}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${getToken()}`
                    }
                });

                const data = await response.json();
                showResponse('customerResponse', data, !response.ok);
            } catch (error) {
                showResponse('customerResponse', { success: false, message: error.message }, true);
            }
        }

        // Get All Customers
        async function getAllCustomers(event) {
            event.preventDefault();

            try {
                const response = await fetch(`${API_BASE_URL}/api/loyalty/customers`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${getToken()}`
                    }
                });

                const data = await response.json();
                showResponse('customerResponse', data, !response.ok);
            } catch (error) {
                showResponse('customerResponse', { success: false, message: error.message }, true);
            }
        }

        // Lookup Customer
        async function lookupCustomer(event) {
            event.preventDefault();
            const customerId = document.getElementById('lookupCustomerId').value;

            if (!customerId) {
                showResponse('lookupResponse', { success: false, message: 'Please enter a customer ID' }, true);
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/api/loyalty/customers/${customerId}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${getToken()}`
                    }
                });

                const data = await response.json();
                showResponse('lookupResponse', data, !response.ok);
            } catch (error) {
                showResponse('lookupResponse', { success: false, message: error.message }, true);
            }
        }

        // Get Customer Discount
        async function getCustomerDiscount(event) {
            event.preventDefault();
            const customerId = document.getElementById('lookupCustomerId').value;

            if (!customerId) {
                showResponse('lookupResponse', { success: false, message: 'Please enter a customer ID' }, true);
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/api/loyalty/customers/${customerId}/discount`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${getToken()}`
                    }
                });

                const data = await response.json();
                showResponse('lookupResponse', data, !response.ok);
            } catch (error) {
                showResponse('lookupResponse', { success: false, message: error.message }, true);
            }
        }

        // Record Purchase
        async function recordPurchase(event) {
            event.preventDefault();

            const requestBody = {
                orderId: document.getElementById('orderId').value,
                amount: parseFloat(document.getElementById('purchaseAmount').value),
                items: document.getElementById('purchaseItems').value || null
            };

            const customerId = document.getElementById('purchaseCustomerId').value;

            try {
                const response = await fetch(`${API_BASE_URL}/api/loyalty/customers/${customerId}/purchases`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${getToken()}`
                    },
                    body: JSON.stringify(requestBody)
                });

                const data = await response.json();
                showResponse('purchaseResponse', data, !response.ok);

                if (response.ok) {
                    event.target.reset();
                }
            } catch (error) {
                showResponse('purchaseResponse', { success: false, message: error.message }, true);
            }
        }

        // Get Purchase History
        async function getPurchaseHistory(event) {
            event.preventDefault();
            const customerId = document.getElementById('purchaseCustomerId').value;

            if (!customerId) {
                showResponse('purchaseResponse', { success: false, message: 'Please enter a customer ID' }, true);
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/api/loyalty/customers/${customerId}/history`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${getToken()}`
                    }
                });

                const data = await response.json();
                showResponse('purchaseResponse', data, !response.ok);
            } catch (error) {
                showResponse('purchaseResponse', { success: false, message: error.message }, true);
            }
        }

        // Get Regular Customers
        async function getRegularCustomers(event) {
            event.preventDefault();

            try {
                const response = await fetch(`${API_BASE_URL}/api/loyalty/customers/regular`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${getToken()}`
                    }
                });

                const data = await response.json();
                showResponse('regularCustomersResponse', data, !response.ok);
            } catch (error) {
                showResponse('regularCustomersResponse', { success: false, message: error.message }, true);
            }
        }

        // Get Active Customers
        async function getActiveCustomers(event) {
            event.preventDefault();

            try {
                const response = await fetch(`${API_BASE_URL}/api/loyalty/customers/active`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${getToken()}`
                    }
                });

                const data = await response.json();
                showResponse('regularCustomersResponse', data, !response.ok);
            } catch (error) {
                showResponse('regularCustomersResponse', { success: false, message: error.message }, true);
            }
        }

        // Get Customers by Tier
        async function getCustomersByTier(event) {
            event.preventDefault();
            const tier = document.getElementById('tierSelect').value;

            try {
                const response = await fetch(`${API_BASE_URL}/api/loyalty/customers/tier/${tier}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${getToken()}`
                    }
                });

                const data = await response.json();
                showResponse('tierResponse', data, !response.ok);
            } catch (error) {
                showResponse('tierResponse', { success: false, message: error.message }, true);
            }
        }

        // Create Loyalty Promotion
        async function createLoyaltyPromotion(event) {
            event.preventDefault();

            const requestBody = {
                promotionCode: document.getElementById('promoCode').value,
                promotionName: document.getElementById('promoName').value,
                description: document.getElementById('promoDescription').value || null,
                minTierRequired: document.getElementById('minTier').value,
                discountPercentage: parseInt(document.getElementById('discountPercent').value),
                pointsCost: parseInt(document.getElementById('pointsCost').value),
                startDate: document.getElementById('startDate').value,
                endDate: document.getElementById('endDate').value
            };

            try {
                const response = await fetch(`${API_BASE_URL}/api/loyalty/promotions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${getToken()}`
                    },
                    body: JSON.stringify(requestBody)
                });

                const data = await response.json();
                showResponse('promotionResponse', data, !response.ok);

                if (response.ok) {
                    event.target.reset();
                }
            } catch (error) {
                showResponse('promotionResponse', { success: false, message: error.message }, true);
            }
        }

        // Get Active Promotions
        async function getActivePromotions(event) {
            event.preventDefault();

            try {
                const response = await fetch(`${API_BASE_URL}/api/loyalty/promotions/active`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${getToken()}`
                    }
                });

                const data = await response.json();
                showResponse('promotionResponse', data, !response.ok);
            } catch (error) {
                showResponse('promotionResponse', { success: false, message: error.message }, true);
            }
        }

        function showResponse(elementId, data, isError) {
            const responseArea = document.getElementById(elementId);
            responseArea.style.display = 'block';
            responseArea.className = 'response-area ' + (isError ? 'error' : 'success');
            responseArea.textContent = JSON.stringify(data, null, 2);
        }

        function goToDashboard() {
            window.location.href = 'dashboard.html';
        }
    </script>
</body>

</html>